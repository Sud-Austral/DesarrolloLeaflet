
@{
    Layout = null;
}

<!DOCTYPE html>
<html>
<head>

    <title>Glaciares</title>

    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A==" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js" integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA==" crossorigin=""></script>

    <script src='http://cdn.leafletjs.com/leaflet/v0.7.7/leaflet-src.js'></script>
    <link href='http://cdn.leafletjs.com/leaflet/v0.7.7/leaflet.css' rel='stylesheet' />

    @{
        string json = "/Scripts/Limites/json/json/" + @ViewBag.glaciar + ".js";
        string divJson = "/Scripts/Limites/json/json_div/" + @ViewBag.glaciar + ".js";
    }


    <script src="@json"></script>
    <script src="@divJson"></script>

    <style>
        body {
            padding: 0;
            margin: 0;
        }

        html, body, #mapid {
            height: 100%;
        }

        .bannerTop {
            width: 100%;
            height: auto;
        }

        .banner {
            width: 50%;
            height: auto;
        }


        /* css to customize Leaflet default styles  */
        .custom .leaflet-popup-tip {
            display: none;
        }

        .legend {
            background: rgba(255, 255, 255, 0.85);
            padding: 5px 10px;
            border-radius: 4px;
        }

        .titleLegend {
            text-align: center;
        }

        /* PÉRDIDA */
        .desc1 {
            background: #BF9000;
            margin-right: 5%;
            border: 1px solid #909090;
        }

        /* GANANCIA */
        .desc2 {
            background: #47C0F8;
            margin-right: 5%;
            border: 1px solid #909090;
        }

        /* SIN CAMBIO */
        .desc3 {
            background: #FFFFFF;
            margin-right: 5%;
            border: 1px solid #909090;
        }

        /* COMPLEJO */
        .desc4 {
            color: #b2ff00;
            margin-right: 5%;
            font-weight: 900;
        }

        /* SECTORES */
        .desc5 {
            color: #edff37;
            margin-right: 5%;
            font-weight: 900;
        }
    </style>

</head>
<body>

    <div id="mapid"></div>
    <script>

        // alert('@ViewBag.q');
        // alert('@ViewBag.p');
        var sn = "";

        if ('@ViewBag.p' == "17-18" && '@ViewBag.q' == "Q1") {

            var epoca = "Q1 (Ene-Abr)"
            var per = "2017 - 2018";
            var sn = "SN_1718q1";
            var g = "G_1718q1";
            var p = "P_1718q1";
            var sc = "SC_1718q1";
            var capa = "glaciares_r10:1718q1";
            var nombre = "Q1 (Ene-Abr) 2017-2018";

        }
        else if ('@ViewBag.p' == "18-19" && '@ViewBag.q' == "Q1") {
            var epoca = "Q1 (Ene-Abr)";
            var per = "P2018 - 2019";
            var sn = "SN_1819q1";
            var g = "G_1819q1";
            var p = "P_1819q1";
            var sc = "SC_1819q1";
            var capa = "glaciares_r10:1819q1";
            var nombre = "Q1 (Ene-Abr) 2018-2019";

        }
        else if ('@ViewBag.p' == "19-20" && '@ViewBag.q' == "Q1") {
            var epoca = "Q1 (Ene-Abr)";
            var per = "2019 - 2020";
            var sn = "SN_1920q1";
            var g = "G_1920q1";
            var p = "P_1920q1";
            var sc = "SC_1920q1";
            var capa = "glaciares_r10:1920q1";
            var nombre = "Q1 (Ene-Abr) 2019-2020";
        }
        else if ('@ViewBag.p' == "20-21" && '@ViewBag.q' == "Q1") {
            var epoca = "Q1 (Ene-Abr)";
            var per = "2020 - 2021";
            var sn = "SN_2021q1";
            var g = "G_2021q1";
            var p = "P_2021q1";
            var sc = "SC_2021q1";
            var capa = "glaciares_r10:2021q1";
            var nombre = "Q1 (Ene-Abr) 2020-2021";
        }
        else if ('@ViewBag.p' == "17-18" && '@ViewBag.q' == "Q2") {
            var epoca = "Q1 (May-Dic)";
            var per = "2017 - 2018";
            var sn = "SN_1718q2";
            var g = "G_1718q2";
            var p = "P_1718q2";
            var sc = "SC_1718q2";
            var capa = "glaciares_r10:1718q2";
            var nombre = "Q2 (May-Dic) 2017-2018";
        }
        else if ('@ViewBag.p' == "18-19" && '@ViewBag.q' == "Q2") {
            var epoca = "Q1 (May-Dic)";
            var per = "2018 - 2019";
            var sn = "SN_1819q2";
            var g = "G_1819q2";
            var p = "P_1819q2";
            var sc = "SC_1819q2";
            var capa = "glaciares_r10:1819q2";
            var nombre = "Q2 (May-Dic) 2018-2019";
        }
        else if ('@ViewBag.p' == "19-20" && '@ViewBag.q' == "Q2") {
            var epoca = "Q1 (May-Dic)";
            var per = "2019 - 2020";
            var sn = "SN_1920q2";
            var g = "G_1920q2";
            var p = "P_1920q2";
            var sc = "SC_1920q2";
            var capa = "glaciares_r10:1920q2";
            var nombre = "Q2 (May-Dic) 2020-2021";
        }
        else {
            null;
        }


        // CREACIÓN Y AGREAGACION DEL MAPA AL DIV
        var map = L.map('mapid').setView([-33.458725187656356, -70.66008634501547], 4);

        // MAPA BASE
        var base = L.tileLayer('https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}?access_token=pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpejY4NXVycTA2emYycXBndHRqcmZ3N3gifQ.rJcFIG214AriISLbB6B5aw', {
            maxZoom: 18,
            attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, ' +
                'Imagery © <a href="https://www.mapbox.com/">Mapbox</a>',
            id: 'mapbox/streets-v11',
            tileSize: 512,
            zoomOffset: -1
        }).addTo(map);

        // ASIGNANDO COLOR A SECTORES POR Shape_Leng
        function getSector(d) {
            return d > 10000 ? '#e67e22' :
                d > 9000 ? '#196f3d' :
                    d > 8000 ? '#21618c' :
                        d > 7000 ? '#154360' :
                            d > 6000 ? '#641e16' :
                                d > 5000 ? '#eb984e' :
                                    d > 4000 ? '#f39c12' :
                                        d > 3000 ? '#f1c40f' :
                                            d > 2000 ? '#28b463' :
                                                d > 1000 ? '#229954' :
                                                    d > 900 ? '#16a085' :
                                                        d > 800 ? '#17a589' :
                                                            d > 700 ? '#2e86c1' :
                                                                d > 600 ? '#2471a3' :
                                                                    d > 500 ? '#6c3483' :
                                                                        d > 400 ? '#884ea0' :
                                                                            d > 300 ? '#cb4335' :
                                                                                d > 200 ? '#a93226' :
                                                                                    d > 100 ? '#34495e' :
                                                                                        '#FFEDA0';
        }

        // ESTILO DE LOS POLÍGONOS / COMPLEJO
        function stylePComplejo(feature) {
            return {
                weight: 3, // Grosor de línea
                color: '#b2ff00', // Color de línea
                opacity: 1.0, // Transparencia de línea
                fillColor: 'transparent', // Color de relleno
                fillOpacity: 1 // Transparencia de relleno
            };
        };

        // ESTILO DE LOS POLÍGONOS / SUBDIVISIÓN
        function styleSectores(feature) {
            return {
                weight: 3, // Grosor de línea
                color: '#edff37', // Color de línea
                opacity: 1.0, // Transparencia de línea
                fillColor: 'transparent', // Color de relleno
                fillOpacity: 1 // Transparencia de relleno
            };
        };

        // POLÍGONOS
        var complejo = L.geoJson(glaciar, { style: stylePComplejo }).addTo(map);
        var subdivision = L.geoJson(division, { style: styleSectores }).addTo(map);

        map.fitBounds(complejo.getBounds());

        // GEOSERVICIO WMS
        var glac = L.tileLayer.wms('https://ide.dataintelligence-group.com/geoserver/glaciares_r10/wms', {
            layers: capa,
            format: 'image/png',
            transparent: true
        }).addTo(map);

        // CAPAS
        var capas = {
            "Complejo glaciar": complejo,
            "Sectores del complejo glaciar": subdivision,
            "Período inexistente": glac,
        };

        if ('@ViewBag.p' == "17-18" && '@ViewBag.q' == "Q1") {

            var overlayMaps = {
                "Mapa del complejo glaciar": complejo,
                "Sectores del complejo glaciar": subdivision,
                "Q1 (Ene-Abr) 2017-2018": glac,
            };
        }
        else if ('@ViewBag.p' == "18-19" && '@ViewBag.q' == "Q1") {

            var overlayMaps = {
                "Mapa del complejo glaciar": complejo,
                "Sectores del complejo glaciar": subdivision,
                "Q1 (Ene-Abr) 2018-2019": glac,
            };
        }
        else if ('@ViewBag.p' == "19-20" && '@ViewBag.q' == "Q1") {

            var overlayMaps = {
                "Mapa del complejo glaciar": complejo,
                "Sectores del complejo glaciar": subdivision,
                "Q1 (Ene-Abr) 2019-2020": glac,
            };
        }
        else if ('@ViewBag.p' == "20-21" && '@ViewBag.q' == "Q1") {
            var overlayMaps = {
                "Mapa del complejo glaciar": complejo,
                "Sectores del complejo glaciar": subdivision,
                "Q1 (Ene-Abr) 2020-2021": glac,
            };
        }
        else if ('@ViewBag.p' == "17-18" && '@ViewBag.q' == "Q2") {
            var overlayMaps = {
                "Mapa del complejo glaciar": complejo,
                "Sectores del complejo glaciar": subdivision,
                "Q2 (May-Dic) 2017-2018": glac,
            };
        }
        else if ('@ViewBag.p' == "18-19" && '@ViewBag.q' == "Q2") {
            
            var overlayMaps = {
                "Mapa del complejo glaciar": complejo,
                "Sectores del complejo glaciar": subdivision,
                "Q2 (May-Dic) 2018-2019": glac,
            };
        }
        else if ('@ViewBag.p' == "19-20" && '@ViewBag.q' == "Q2") {

            var overlayMaps = {
                "Mapa del complejo glaciar": complejo,
                "Sectores del complejo glaciar": subdivision,
                "Q2 (May-Dic) 2019-2020": glac,
            };
        }

        else {
            null;
        }

        L.control.layers(capas, overlayMaps, {
            position: 'topright', // 'topleft', 'bottomleft', 'bottomright'
            collapsed: false // true
        }).addTo(map);

        map.removeLayer(subdivision);
        map.removeLayer(glac);

        // specify popup options
        var customOptions =
        {
            'className': 'custom'
        }

        // POPUP COMPLEJO GLACIAR
        function popupComplejo(feature, layer) {

            if (feature.properties && feature.properties.idZonGlac) {
                layer.bindPopup("<img class='bannerTop' src='https://raw.githubusercontent.com/Sud-Austral/mapa_glaciares/main/img/Glaciares.jpg' alt='Data Intelligence'/><br><br>" +
                    "<b><center>" + feature.properties.Nombre_Gla + "</center></b>" +
                    "<br><b>Región: </b>" + feature.properties.NOM_REGION +
                    "<br><b>Provincia: </b>" + feature.properties.NOM_PROVIN +
                    "<br><b>Comuna: </b>" + feature.properties.NOM_COMUNA + "<br>" +

                    "<br><b>Época: </b>" + epoca +
                    "<br><b>Período: </b>" + per +
                    "<br><b>Superficie sin nieve (ha): </b>" + feature.properties[sn] + //SN_1718q1
                    "<br><b>Superficie ganancia (ha): </b>" + feature.properties[g] +
                    "<br><b>Superficie pérdida (ha): </b>" + feature.properties[p] +
                    "<br><b>Superficie sin cambio (ha): </b>" + feature.properties[sc] + "<br><br>" +
                    "<center><img class='banner' src='https://raw.githubusercontent.com/Sud-Austral/mapa_glaciares/main/img/logo_DataIntelligence_normal.png' alt='Data Intelligence'/></center>", customOptions);

            }
        }

        // .toFixed(2) - Cantidad de decimales

        L.geoJson(glaciar, {
            style: stylePComplejo, onEachFeature: popupComplejo
        }).addTo(complejo);

        // POPUP SECTOR COMPLEJO GLACIAR
        function popupSector(feature, layer) {
            if (feature.properties && feature.properties.idZonGlac) {
                var codGla = ""
                if (feature.properties.COD_GLA == "") {
                    codGla = "No definido"
                } else {
                    codGla = feature.properties.COD_GLA
                }
                layer.bindPopup("<img class='bannerTop' src='https://raw.githubusercontent.com/Sud-Austral/mapa_glaciares/main/img/Glaciares.jpg' alt='Data Intelligence'/><br><br>" +
                    "<b><center>" + feature.properties.Nombre_GLA + "</center></b>" +
                    "<br><b>Región: </b>" + feature.properties.NOM_REGION +
                    "<br><b>Provincia: </b>" + feature.properties.NOM_PROVIN +
                    "<br><b>Comuna: </b>" + feature.properties.NOM_COMUNA + "<br>" +

                    "<br><b>Código del glaciar: </b>" + codGla +
                    "<br><b>Nombre del glaciar: </b>" + feature.properties.NOMBRE +
                    "<br><b>Subsubcuenca: </b>" + feature.properties.NOM_SSUBC + "<br>" +
                    "<br><b>Época: </b>" + epoca +
                    "<br><b>Período: </b>" + per +
                    "<br><b>Superficie sin nieve (ha): </b>" + feature.properties[sn] + //SN_1718q1
                    "<br><b>Superficie ganancia (ha): </b>" + feature.properties[g] +
                    "<br><b>Superficie pérdida (ha): </b>" + feature.properties[p] +
                    "<br><b>Superficie sin cambio (ha): </b>" + feature.properties[sc] + "<br><br>" +
                    "<center><img class='banner' src='https://raw.githubusercontent.com/Sud-Austral/mapa_glaciares/main/img/logo_DataIntelligence_normal.png' alt='Data Intelligence'/></center>", customOptions);

            }
        }

        L.geoJson(division, {
            style: styleSectores, onEachFeature: popupSector
        }).addTo(subdivision);

        var legendP = L.control({ position: 'bottomright' });
        legendP.onAdd = function (map) {

            var div = L.DomUtil.create('div', 'info legend'),
                grades = [14000, 800000, 2000000, 6800000, 680000],
                labels = [],
                from, to;

            for (var i = 0; i < grades.length; i++) {
                div.innerHTML +=
                    '<i style="background:' + getColorP(grades[i] + 1) + '"></i> ' +
                    grades[i] + (grades[i + 1] ? '&ndash;' + grades[i + 1] + '<br>' : '+');
            };
            return div;
        };

        // AGREGANDO LEYENDA
        var legend = L.control({ position: 'bottomright' });

        legend.onAdd = function (map) {
            var div = L.DomUtil.create('div', 'legend');

            div.innerHTML +=
                '<div>' +
                    '<p class="titleLegend"><b>LEYENDA - GLACIARES</b></p>' +
                    '<p><span class="desc1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>PÉRDIDA<br>' +
                    '<span class="desc2">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>GANANCIA<br>' +
                    '<span class="desc3">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>SIN CAMBIO<br>' +
                    '<span class="desc4">--------</span>COMPLEJO GLACIAR<br>' +
                    '<span class="desc5">--------</span>SECTOR DEL COMPLEJO GLACIAR<br>' +
                    '</p>' +
                '</div>';

            return div;
        };

        legend.addTo(map);
    </script>

</body>
</html>
